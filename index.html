<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Timer (GM Hidden Hint System)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for low-latency tick sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* Custom font for the dramatic timer display */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap');
        .timer-font {
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px rgba(255, 60, 0, 0.7); /* Subtle glow effect */
        }
        /* Custom styles for the overlay message */
        .overlay {
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }
        /* Simple animation for fade in/out */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Hint/Countdown message specific style */
        .hint-overlay {
            z-index: 20;
            top: 50%;
            left: 50%;
            transform: translate(-55%, -50%);
            width: 90%;
            max-width: 600px;
            /* Use red glow for penalty notification */
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.9); 
        }
        /* Ensure the GM controls are hidden by default to prevent flashing */
        #gm-settings-container {
            display: none;
        }
        /* Style for error inputs */
        .input-error-border {
            border-color: #f87171 !important; /* Tailwind red-400 */
            box-shadow: 0 0 5px #f87171;
        }
    </style>
    <script>
        // --- GLOBAL STATE ---
        let totalSeconds = 3600; 
        let initialTotalSeconds = 3600;
        let timerInterval = null;
        let countdownInterval = null;
        let countdownValue = 3;
        let isRunning = false;
        
        // --- HINT STATE (Penalties Only) ---
        let hintUsedStatus = [false, false, false]; // Tracks which hints have been used in the current run
        let hintPenaltyMinutes = 5; // Default 5 minutes penalty
        
        // --- AUDIO OBJECTS ---
        let synth = null; // Tone.js for tick
        let successChime = null; // Tone.js for success
        let bgMusic = null; // Native Audio for custom background track
        let gameOverAudio = null; // Native Audio for custom game over alarm
        
        // Default URLs: Empty string means no custom audio is currently active.
        let bgMusicUrl = ''; 
        let gameOverUrl = ''; 
        let startSoundUrl = '';
        
        const LOCAL_STORAGE_KEY = 'escapeRoomTimerSettings';

        // --- HELPER FUNCTIONS ---
        function isLocalFilePath(url) {
            return url && url.startsWith('file:///');
        }

        function getDisplayValue(url) {
            if (!url || url.trim() === '') return 'No File Selected / Paste URL';
            if (url.startsWith('data:')) return 'File Loaded (Data URL)';
            if (isLocalFilePath(url)) return 'ðŸš« ERROR: Local File Path Not Allowed';
            return url;
        }
        
        function applyInputError(inputId, isError) {
            const input = document.getElementById(inputId);
            const warningId = `${inputId}-warning`;
            let warning = document.getElementById(warningId);

            if (isError) {
                input.classList.add('input-error-border');
                if (!warning) {
                    warning = document.createElement('p');
                    warning.id = warningId;
                    warning.className = 'text-xs text-red-400 mt-1';
                    input.parentElement.appendChild(warning);
                }
                warning.textContent = 'This local file path is blocked by the browser. Please use "Upload File" or a public link.';
            } else {
                input.classList.remove('input-error-border');
                if (warning) {
                    warning.remove();
                }
            }
        }
        // --- END HELPER FUNCTIONS ---


        // --- LOCAL STORAGE FUNCTIONS ---

        function saveSettings() {
            // Called every time an input changes
            const minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            const seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            
            // Handle URL inputs: 
            // 1. Update state variables for manual URL input.
            // 2. Data URLs (from uploads) are set in handleFileUpload and are NOT saved to localStorage.
            
            // If the user types over 'File Loaded (Data URL)', we assume they are pasting a public URL.
            const newStartUrl = document.getElementById('start-sound-input').value.trim();
            if (!newStartUrl.startsWith('File Loaded')) {
                startSoundUrl = newStartUrl; 
            }
            
            const newBgUrl = document.getElementById('bg-music-input').value.trim();
            if (!newBgUrl.startsWith('File Loaded')) {
                bgMusicUrl = newBgUrl; 
            }

            const newGameOverUrl = document.getElementById('game-over-input').value.trim();
            if (!newGameOverUrl.startsWith('File Loaded')) {
                gameOverUrl = newGameOverUrl; 
            }

            // After updating state variables, check and apply visual errors
            applyInputError('start-sound-input', isLocalFilePath(startSoundUrl));
            applyInputError('bg-music-input', isLocalFilePath(bgMusicUrl));
            applyInputError('game-over-input', isLocalFilePath(gameOverUrl));


            hintPenaltyMinutes = parseInt(document.getElementById('penalty-input').value) || 5;
            
            // IMPORTANT FIX: To avoid QuotaExceededError, DO NOT save large data URLs.
            // Only save the URL string if it's NOT a data URL (i.e., it's a public HTTP/HTTPS link or an empty string).
            const settingsData = {
                initialMinutes: minutes,
                initialSeconds: seconds,
                bgMusicUrl: bgMusicUrl.startsWith('data:') ? '' : bgMusicUrl, 
                gameOverUrl: gameOverUrl.startsWith('data:') ? '' : gameOverUrl, 
                startSoundUrl: startSoundUrl.startsWith('data:') ? '' : startSoundUrl, 
                hintPenaltyMinutes: hintPenaltyMinutes,
            };

            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(settingsData));
                console.log("Settings saved to localStorage.");
                updateHintButtons(); // Update button labels if penalty changes
            } catch (e) {
                // Console error retained to track storage usage
                console.error("Error saving to localStorage:", e);
                // If it's a quota error, warn the user about saving the state.
                if (e.name === 'QuotaExceededError') {
                     showPenaltyMessage("Error: Browser storage limit reached. Time settings saved, but audio files must be re-uploaded on refresh.", 8000, 'bg-red-700/90');
                }
            }
        }
        
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
                
                if (storedSettings) {
                    const data = JSON.parse(storedSettings);
                    
                    // Restore time inputs
                    const min = data.initialMinutes || 60;
                    const sec = data.initialSeconds || 0;
                    document.getElementById('minutes-input').value = min;
                    document.getElementById('seconds-input').value = sec;
                    
                    // Restore global URL variables. Default to empty string if no public URL was saved.
                    bgMusicUrl = data.bgMusicUrl || '';
                    gameOverUrl = data.gameOverUrl || '';
                    startSoundUrl = data.startSoundUrl || '';
                    
                    // Restore URL inputs/display fields with updated display function
                    document.getElementById('bg-music-input').value = getDisplayValue(bgMusicUrl);
                    document.getElementById('game-over-input').value = getDisplayValue(gameOverUrl);
                    document.getElementById('start-sound-input').value = getDisplayValue(startSoundUrl);

                    // Apply visual errors if any loaded URL is a local path
                    applyInputError('start-sound-input', isLocalFilePath(startSoundUrl));
                    applyInputError('bg-music-input', isLocalFilePath(bgMusicUrl));
                    applyInputError('game-over-input', isLocalFilePath(gameOverUrl));

                    // Restore Hint settings
                    hintPenaltyMinutes = data.hintPenaltyMinutes || 5;
                    document.getElementById('penalty-input').value = hintPenaltyMinutes;
                    
                    // Set initial timer state from loaded time
                    totalSeconds = (min * 60) + sec;
                    initialTotalSeconds = totalSeconds;
                    
                    console.log("Settings loaded from localStorage.");
                } else {
                    console.log("No saved settings found. Using defaults.");
                    // Since default audio URLs are now empty strings, no need to apply visual errors here.
                }
            } catch (error) {
                console.error("Error loading settings from localStorage:", error);
            }
            updateDisplay(); // Update UI after loading/defaults are set
        }

        // --- FILE UPLOAD HANDLER ---
        function handleFileUpload(event, type, displayId) {
            const file = event.target.files[0];
            const displayInput = document.getElementById(displayId);
            
            if (!file) {
                // If the user cancels the file dialog
                displayInput.value = getDisplayValue(null);
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const dataUrl = e.target.result;

                // Set the global state variable to the Data URL (this is only for the current session)
                if (type === 'start') {
                    startSoundUrl = dataUrl;
                } else if (type === 'bg') {
                    bgMusicUrl = dataUrl;
                } else if (type === 'gameOver') {
                    gameOverUrl = dataUrl;
                }
                
                // Update display input to show file loaded state and remove any previous error
                displayInput.value = `File Loaded (Data URL)`;
                applyInputError(displayId, false); // Remove error border
                saveSettings(); // Save other settings (time, penalty) and mark URL as empty in storage
                console.log(`Audio file for ${type} loaded: ${file.name} (temporary, not saved in local storage)`);
            };

            reader.onerror = function(e) {
                console.error("Error reading file:", e);
                // Clear state variable on error, revert to default error state (empty string)
                if (type === 'start') startSoundUrl = '';
                else if (type === 'bg') bgMusicUrl = '';
                else if (type === 'gameOver') gameOverUrl = '';
                displayInput.value = 'File Load Error';
                applyInputError(displayId, true); // Add error border for read failure
                saveSettings();
            };

            reader.readAsDataURL(file);
        }
        // --- END FILE UPLOAD HANDLER ---

        // --- AUDIO SETUP AND CONTROL ---
        function setupAudio() {
            try {
                // Initialize Tone.js for synthetic, low-latency sounds (tick, success chime)
                synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 1,
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.01 }
                }).toDestination();
                
                successChime = new Tone.PolySynth(Tone.Synth, {
                    envelope: { attack: 0.05, decay: 0.5, sustain: 0.1, release: 1 }
                }).toDestination();
                
                // Start audio context on first user interaction
                document.body.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') {
                        Tone.context.resume();
                    }
                }, { once: true });

            } catch (e) {
                console.error("Tone.js failed to initialize:", e);
                // Fallback objects
                synth = { triggerAttackRelease: () => {} };
                successChime = { triggerAttackRelease: () => {} };
            }
        }

        function playStartSound() {
            if (isLocalFilePath(startSoundUrl)) {
                 console.warn("Cannot play Start Sound: Local file path is blocked.");
                 return;
            }
            if (startSoundUrl && startSoundUrl.trim() !== '') {
                const audioSource = startSoundUrl.trim();
                const startAudio = new Audio(audioSource);
                startAudio.volume = 1.0;
                // If this fails (like if it's not a direct audio link), log the error but don't stop execution
                startAudio.play().catch(e => console.error("Could not play custom Start Sound (check link or file is valid):", e));
            } else {
                // FALLBACK: Use Tone.js for a synthetic start chime if no source is provided.
                console.log("No custom start sound provided. Using synthetic Tone.js chime.");
                const now = Tone.now();
                if (successChime) successChime.triggerAttackRelease(["C5", "E5"], "8n", now);
            }
        }

        function playBgMusic() {
            stopBgMusic(); // Ensure any existing music is stopped
            if (isLocalFilePath(bgMusicUrl)) {
                 console.warn("Cannot play Background Music: Local file path is blocked.");
                 return;
            }
            if (bgMusicUrl) {
                bgMusic = new Audio(bgMusicUrl);
                bgMusic.loop = true;
                bgMusic.volume = 0.6; // Keep it subtle
                bgMusic.play().catch(e => console.error("Could not play BG Music (check link or file is valid):", e));
            }
        }

        function stopBgMusic() {
            if (bgMusic) {
                bgMusic.pause();
                bgMusic.currentTime = 0;
                bgMusic = null;
            }
        }
        
        function playGameOverAudio(success) {
            stopBgMusic(); // Stop BG music immediately

            if (success) {
                // Play Tone.js success chime
                const now = Tone.now();
                if (successChime) successChime.triggerAttackRelease(["C4", "E4", "G4", "C5"], "1n", now);
            } else if (gameOverUrl && !isLocalFilePath(gameOverUrl)) {
                // Play custom Game Over sound
                gameOverAudio = new Audio(gameOverUrl);
                gameOverAudio.volume = 1.0;
                gameOverAudio.play().catch(e => console.error("Could not play Game Over Audio (check link or file is valid):", e));
            } else {
                // Fallback: Use Tone.js for a boom/explosion sound if no custom URL or if it's blocked
                if (isLocalFilePath(gameOverUrl)) {
                    console.warn("Cannot play Game Over Audio: Local file path is blocked. Using fallback.");
                }
                const boomNoise = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.005, decay: 1.5, sustain: 0, release: 0.1 }
                }).toDestination();
                boomNoise.triggerAttackRelease("1n");
            }
        }

        // --- TIMER & HINT LOGIC ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(remainingSeconds).padStart(2, '0');
            
            return `${paddedMinutes}:${paddedSeconds}`;
        }
        
        function updateDisplay() {
            const timerDisplay = document.getElementById('timer-display');
            const progressBar = document.getElementById('progress-bar');
            timerDisplay.textContent = formatTime(totalSeconds);

            const percentage = initialTotalSeconds > 0 ? (totalSeconds / initialTotalSeconds) * 100 : 100;
            progressBar.style.width = `${Math.max(0, percentage)}%`;

            // Color and Pulse Logic
            if (totalSeconds <= 60 && totalSeconds > 0) {
                timerDisplay.classList.remove('text-red-600', 'text-orange-400');
                timerDisplay.classList.add('text-yellow-400', 'animate-pulse');
            } else if (totalSeconds <= 0) {
                timerDisplay.classList.remove('text-orange-400', 'text-yellow-400', 'animate-pulse');
                timerDisplay.classList.add('text-red-600');
                showResult(false);
                // Ensure timer stops instantly if totalSeconds <= 0
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;
                }
            } else {
                timerDisplay.classList.remove('text-yellow-400', 'text-red-600', 'animate-pulse');
                timerDisplay.classList.add('text-orange-400');
            }
            
            // Progress bar color
            if (percentage <= 20) {
                progressBar.className = 'h-full rounded-full bg-red-600 transition-all duration-500';
            } else if (percentage <= 50) {
                progressBar.className = 'h-full rounded-full bg-yellow-500 transition-all duration-500';
            } else {
                progressBar.className = 'h-full rounded-full bg-green-500 transition-all duration-500';
            }
        }

        function tick() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
                
                // Play low-latency tick sound every second
                if (synth) synth.triggerAttackRelease("C1", "16n");
                
                // Urgent warning sound for last 10 seconds
                if (totalSeconds <= 10 && totalSeconds > 0) {
                    if (synth) synth.triggerAttackRelease("G2", "32n", "+0.2"); 
                }

            } else {
                // Stop logic is handled by updateDisplay
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;
                    playGameOverAudio(false);
                }
            }
        }
        
        // --- START/PAUSE/RESET LOGIC ---

        function setTime(shouldSave = false) {
            if (isRunning) return;
            
            let minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            let seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            
            minutes = Math.max(0, Math.min(99, minutes));
            seconds = Math.max(0, Math.min(59, seconds));
            
            totalSeconds = (minutes * 60) + seconds;
            initialTotalSeconds = totalSeconds; 
            
            if (shouldSave) {
                saveSettings(); // Save settings on start
            }
            
            updateDisplay();
        }

        function showCountdownMessage(message, colorClass = 'bg-black/90') {
            const hintOverlay = document.getElementById('hint-message-overlay');
            const hintText = document.getElementById('hint-message-text');

            // Use a much larger font size and a more urgent glow for the start countdown
            hintText.className = 'text-9xl font-extrabold timer-font tracking-widest';
            
            // Clear previous classes and set new ones for overlay
            hintOverlay.className = `overlay fixed hint-overlay p-8 rounded-2xl text-center fade-in z-20 ${colorClass} text-white`;
            hintText.textContent = message;
            hintOverlay.classList.remove('hidden');
        }

        function hideCountdownMessage() {
            document.getElementById('hint-message-overlay').classList.add('hidden');
            // Reset the text size back to the default penalty style for later use
            document.getElementById('hint-message-text').className = 'text-3xl font-bold timer-font tracking-wide'; 
        }

        function finalizeStart() {
            // This function runs after the 3-2-1 countdown is complete
            if (totalSeconds > 0) {
                isRunning = true;
                
                // 1. Play custom START sound (or fallback)
                playStartSound();

                // 2. Play custom background music
                playBgMusic();

                document.getElementById('start-btn').textContent = 'Running...';
                document.getElementById('start-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
                
                timerInterval = setInterval(tick, 1000);
            }
        }

        function initiateCountdown() {
            if (isRunning) return;
            // Stop any running timer/countdown just in case
            if (timerInterval) clearInterval(timerInterval);
            if (countdownInterval) clearInterval(countdownInterval);

            setTime(true); // Save and set initial time
            
            if (totalSeconds <= 0) {
                // If time is 0, just reset and don't start
                resetTimer(); 
                return;
            }

            // Preparation steps: Disable start button, hide GM settings, reset hint status
            hintUsedStatus = [false, false, false]; 
            updateHintButtons();
            document.getElementById('gm-settings-container').style.display = 'none';
            document.getElementById('start-btn').disabled = true;
            hideResult();

            // Start the 3-2-1 sequence
            countdownValue = 3;
            showCountdownMessage(countdownValue, 'bg-black/90 border-4 border-white');
            
            if (synth) synth.triggerAttackRelease("G3", "8n"); 

            countdownInterval = setInterval(() => {
                countdownValue--;
                if (countdownValue > 0) {
                    showCountdownMessage(countdownValue, 'bg-black/90 border-4 border-white');
                    if (synth) synth.triggerAttackRelease("G3", "8n"); 
                } else if (countdownValue === 0) {
                    showCountdownMessage("GO!", 'bg-green-800/90 border-4 border-green-400');
                    if (synth) successChime.triggerAttackRelease(["C4"], "4n"); // Use success chime for GO
                    
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    
                    // Finalize the start after a 1-second display of "GO!"
                    setTimeout(() => {
                        hideCountdownMessage();
                        finalizeStart();
                    }, 1000);
                }
            }, 1000);
        }

        function startTimer() {
            if (isRunning) return;
            initiateCountdown();
        }
        
        function pauseTimer() {
            if (!isRunning || !timerInterval) return;
            
            isRunning = false;
            clearInterval(timerInterval);
            timerInterval = null;

            stopBgMusic(); // Stop background music on pause

            document.getElementById('start-btn').textContent = 'Resume';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;

            // GM Mode: Show settings while paused (Hint buttons are in here)
            document.getElementById('gm-settings-container').style.display = 'block';

            updateDisplay();
        }

        function resetTimer() {
            pauseTimer();

            // Use the last saved time from the inputs to reset
            const minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            const seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            totalSeconds = (minutes * 60) + seconds;
            initialTotalSeconds = totalSeconds;
            
            hintUsedStatus = [false, false, false]; // Reset hint usage
            updateHintButtons(); // Ensure hint buttons are enabled

            document.getElementById('start-btn').textContent = 'Start';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;
            
            // GM Mode: Show settings on reset
            document.getElementById('gm-settings-container').style.display = 'block';

            updateDisplay();
            hideResult();
        }

        
        // --- HINT ACTIVATION LOGIC ---

        function activateHint(hintIndex) {
            if (!isRunning) {
                console.warn("Timer not running. Cannot activate hint.");
                showPenaltyMessage("Timer must be running to activate hints.", 3000, 'bg-gray-700/90');
                return;
            }
            
            if (hintIndex < 0 || hintIndex > 2) return;

            // Check if already used
            if (hintUsedStatus[hintIndex]) {
                showPenaltyMessage(`Hint ${hintIndex + 1} already used in this game.`, 3000, 'bg-gray-700/90');
                return;
            }

            // 1. Apply Penalty
            const penaltySeconds = hintPenaltyMinutes * 60;
            totalSeconds -= penaltySeconds;
            totalSeconds = Math.max(0, totalSeconds); // Prevent negative time
            updateDisplay();

            // 2. Mark as Used
            hintUsedStatus[hintIndex] = true;
            updateHintButtons(); // Update button state

            // 3. Show Message
            const penaltyText = hintPenaltyMinutes > 0 ? `${hintPenaltyMinutes} minutes penalty` : 'no time penalty';
            const fullMessage = `Hint ${hintIndex + 1} used, ${penaltyText} applied!`;
            showPenaltyMessage(fullMessage, 7000, 'bg-red-800/90');
        }

        function updateHintButtons() {
            // This function updates the state of the Hint buttons in the GM settings panel
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`hint-btn-${i}`);
                if (!btn) continue; // Skip if button hasn't loaded

                const key = i;
                const penaltyText = hintPenaltyMinutes > 0 ? `-${hintPenaltyMinutes} Min` : 'NO PENALTY';

                if (hintUsedStatus[i - 1]) {
                    btn.disabled = true;
                    btn.classList.add('bg-gray-500', 'hover:bg-gray-500', 'cursor-not-allowed');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.textContent = `Hint ${i} (USED)`;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('bg-gray-500', 'hover:bg-gray-500', 'cursor-not-allowed');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    btn.textContent = `Hint ${i} (Key ${key}) (${penaltyText})`;
                }
            }
        }
        
        function showPenaltyMessage(message, duration, colorClass) {
            const hintOverlay = document.getElementById('hint-message-overlay');
            const hintText = document.getElementById('hint-message-text');

            // Set the text size correct for a penalty message
            hintText.className = 'text-3xl font-bold timer-font tracking-wide'; 
            
            // Clear previous classes and set new ones
            hintOverlay.className = `overlay fixed hint-overlay p-6 rounded-xl text-center fade-in z-20 ${colorClass} text-white`;
            hintText.textContent = message;
            hintOverlay.classList.remove('hidden');

            setTimeout(() => {
                hintOverlay.classList.add('hidden');
            }, duration);
        }
        
        // --- RESULT AND WIN/LOSS LOGIC ---

        function showResult(success) {
            pauseTimer(); // Stop the timer and music

            playGameOverAudio(success); 

            const resultOverlay = document.getElementById('result-overlay');
            const resultMessage = document.getElementById('result-message');
            
            if (success) {
                resultMessage.textContent = "SUCCESS! You Escaped!";
                resultOverlay.classList.remove('bg-red-900/90');
                resultOverlay.classList.add('bg-green-800/90');
            } else {
                resultMessage.textContent = "TIME'S UP! Game Over.";
                resultOverlay.classList.remove('bg-green-800/90');
                resultOverlay.classList.add('bg-red-900/90');
            }
            
            resultOverlay.classList.remove('hidden');
        }
        
        function hideResult() {
            document.getElementById('result-overlay').classList.add('hidden');
        }

        function winGame() {
            if (!isRunning) return;
            pauseTimer();
            showResult(true); // True for success
            document.getElementById('reset-btn').disabled = false;
        }

        // --- KEYBOARD LISTENER ---
        document.addEventListener('keydown', (event) => {
            // Ignore if focus is on an input field
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                return;
            }

            if (isRunning) {
                // Hint Penalties
                if (event.key === '1') {
                    activateHint(0);
                } else if (event.key === '2') {
                    activateHint(1);
                } else if (event.key === '3') {
                    activateHint(2);
                } 
                // Win Game
                else if (event.key === '5') {
                    winGame();
                }
            }
        });

        // --- INITIALIZATION ---
        window.onload = async function() {
            // 1. Setup Audio
            setupAudio();
            
            // Setup input listeners for saving settings automatically
            document.getElementById('minutes-input').addEventListener('input', () => setTime());
            document.getElementById('seconds-input').addEventListener('input', () => setTime());
            
            // Listeners for manual URL paste (updates state variable implicitly via saveSettings)
            document.getElementById('bg-music-input').addEventListener('input', saveSettings);
            document.getElementById('game-over-input').addEventListener('input', saveSettings);
            document.getElementById('start-sound-input').addEventListener('input', saveSettings);

            document.getElementById('penalty-input').addEventListener('input', saveSettings);
            
            // 2. Load persistent settings from localStorage
            loadSettings();
            updateHintButtons(); // Initial setup of hint button text/state

            // 3. Initial UI setup
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;
            // Make GM settings visible on load
            document.getElementById('gm-settings-container').style.display = 'block';
        };

    </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Game Over/Success Overlay -->
    <div id="result-overlay" class="overlay hidden fixed inset-0 flex items-center justify-center transition-opacity duration-500 fade-in">
        <div class="p-8 rounded-xl shadow-2xl text-center border-4 border-white/50 animate-bounce-in">
            <h2 id="result-message" class="text-7xl md:text-9xl font-extrabold timer-font text-white"></h2>
            <button onclick="resetTimer()" class="mt-8 px-6 py-3 bg-white text-gray-900 font-bold rounded-lg hover:bg-gray-200 transition duration-150 shadow-lg">
                Start New Game
            </button>
        </div>
    </div>
    
    <!-- Hint/Warning Message Overlay (Reused for 3-2-1 Countdown) -->
    <div id="hint-message-overlay" class="hint-overlay hidden fixed">
        <p id="hint-message-text" class="text-3xl font-bold timer-font tracking-wide"></p>
    </div>


    <!-- Main Timer Container -->
    <div class="w-full max-w-4xl bg-gray-800 p-6 md:p-10 rounded-2xl shadow-2xl border border-gray-700/50">
        
        <h1 class="text-3xl font-bold text-center mb-6 text-red-500 tracking-wider uppercase">
            ESCAPE ROOM: SOLVE THE MYSTERY
        </h1>
        
        <!-- Timer Display -->
        <div class="mb-4">
            <div id="timer-display" 
                class="timer-font text-8xl sm:text-9xl md:text-[10rem] font-extrabold text-orange-400 text-center p-4 bg-black/50 rounded-lg border-2 border-red-700 shadow-inner shadow-red-900 transition-colors duration-500">
                60:00
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="h-4 w-full bg-gray-700 rounded-full mb-8 overflow-hidden border border-red-900">
            <div id="progress-bar" 
                 class="h-full rounded-full bg-green-500 transition-all duration-500" 
                 style="width: 100%;">
            </div>
        </div>

        <!-- GM Settings Panel (Hidden when Running) -->
        <div id="gm-settings-container" style="display: none;" class="fade-in">

            <h2 class="text-xl font-bold text-center mb-4 text-gray-300 border-b border-gray-700 pb-2">
                Game Master Settings & Hidden Controls
            </h2>

            <!-- Time Setting Inputs -->
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-8 mb-6">
                <div class="flex items-center space-x-2">
                    <label for="minutes-input" class="text-xl font-medium text-gray-400">Start Minutes:</label>
                    <input type="number" id="minutes-input" min="0" max="99" value="60" 
                           class="w-24 p-3 text-2xl bg-gray-700 border-2 border-red-600 rounded-lg text-white timer-font text-center focus:outline-none focus:ring-2 focus:ring-red-400 transition" />
                </div>
                <div class="flex items-center space-x-2">
                    <label for="seconds-input" class="text-xl font-medium text-gray-400">Start Seconds:</label>
                    <input type="number" id="seconds-input" min="0" max="59" value="0"
                           class="w-24 p-3 text-2xl bg-gray-700 border-2 border-red-600 rounded-lg text-white timer-font text-center focus:outline-none focus:ring-2 focus:ring-red-400 transition" />
                </div>
            </div>
            
            <!-- Hint Penalty and Control Panel -->
            <div class="mb-8 p-4 bg-gray-700 rounded-xl border border-blue-600">
                <h3 class="text-xl font-bold text-center mb-4 text-blue-300">
                    Hint Penalty Configuration & Activation
                </h3>

                <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-8 mb-6">
                    <div class="flex items-center space-x-2">
                        <label for="penalty-input" class="text-md font-medium text-gray-400 min-w-[150px]">Time Penalty (Minutes):</label>
                        <input type="number" id="penalty-input" min="0" max="60" value="5"
                               class="w-24 p-2 bg-gray-600 border border-gray-500 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-400 transition" />
                    </div>
                </div>

                <p class="text-center text-sm text-yellow-400 mb-4">
                    *Press **Keys 1, 2, or 3** during the game to instantly apply the penalty. Press **Key 5** to trigger Win Game.
                </p>

                <div class="flex flex-wrap justify-center gap-4">
                    <button id="hint-btn-1" onclick="activateHint(0)" 
                            class="flex-1 min-w-[150px] max-w-[200px] px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                        Hint 1 (Key 1) (-5 Min)
                    </button>
                    <button id="hint-btn-2" onclick="activateHint(1)" 
                            class="flex-1 min-w-[150px] max-w-[200px] px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                        Hint 2 (Key 2) (-5 Min)
                    </button>
                    <button id="hint-btn-3" onclick="activateHint(2)" 
                            class="flex-1 min-w-[150px] max-w-[200px] px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                        Hint 3 (Key 3) (-5 Min)
                    </button>
                </div>
            </div>

            <!-- Custom Audio Inputs -->
            <div class="space-y-4 mb-8 p-4 bg-gray-700/50 rounded-lg border border-gray-600">
                <h3 class="text-lg font-bold text-gray-300 mb-2">Custom Audio Files/URLs</h3>
                <p class="text-sm text-yellow-300 font-medium">
                    *Upload a local audio file or paste a direct URL below.
                    <span class="text-red-300 font-bold block mt-1">
                        Warning: Uploaded files are large and will NOT persist across sessions due to browser storage limits.
                    </span>
                </p>
                
                <!-- Start Sound Input -->
                <div class="space-y-1">
                    <label for="start-sound-input" class="block text-md font-medium text-gray-400 mb-1">Start Sound (Plays Once):</label>
                    <div class="flex space-x-2">
                        <input type="file" id="start-file-input" accept="audio/*" class="hidden" 
                               onchange="handleFileUpload(event, 'start', 'start-sound-input')" />
                        <label for="start-file-input" class="cursor-pointer px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm font-medium transition whitespace-nowrap shadow-md">
                            Upload File
                        </label>
                        <input type="text" id="start-sound-input" placeholder="Paste PUBLIC URL or use Upload File"
                               class="flex-1 p-2 bg-gray-600 border border-gray-500 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-400 transition" />
                    </div>
                </div>

                <!-- Background Music Input -->
                <div class="space-y-1">
                    <label for="bg-music-input" class="block text-md font-medium text-gray-400 mb-1">Background Music (Loops):</label>
                    <div class="flex space-x-2">
                        <input type="file" id="bg-file-input" accept="audio/*" class="hidden" 
                               onchange="handleFileUpload(event, 'bg', 'bg-music-input')" />
                        <label for="bg-file-input" class="cursor-pointer px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm font-medium transition whitespace-nowrap shadow-md">
                            Upload File
                        </label>
                        <input type="text" id="bg-music-input" placeholder="Paste PUBLIC URL or use Upload File"
                               class="flex-1 p-2 bg-gray-600 border border-gray-500 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-400 transition" />
                    </div>
                </div>

                <!-- Game Over Input -->
                <div class="space-y-1">
                    <label for="game-over-input" class="block text-md font-medium text-gray-400 mb-1">Game Over Alarm (Plays Once):</label>
                    <div class="flex space-x-2">
                        <input type="file" id="game-over-file-input" accept="audio/*" class="hidden" 
                               onchange="handleFileUpload(event, 'gameOver', 'game-over-input')" />
                        <label for="game-over-file-input" class="cursor-pointer px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-sm font-medium transition whitespace-nowrap shadow-md">
                            Upload File
                        </label>
                        <input type="text" id="game-over-input" placeholder="Paste PUBLIC URL or use Upload File"
                               class="flex-1 p-2 bg-gray-600 border border-gray-500 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-400 transition" />
                    </div>
                </div>
            </div>

        </div>


        <!-- Control Buttons (Player Facing) -->
        <div class="flex flex-wrap justify-center gap-4">
            <button id="start-btn" onclick="startTimer()" 
                    class="flex-1 min-w-[120px] max-w-[200px] px-6 py-4 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl shadow-xl hover:shadow-2xl transition duration-150 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                Start
            </button>
            <button id="pause-btn" onclick="pauseTimer()" disabled
                    class="flex-1 min-w-[120px] max-w-[200px] px-6 py-4 bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold text-lg rounded-xl shadow-xl hover:shadow-2xl transition duration-150 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                Pause
            </button>
            <button id="reset-btn" onclick="resetTimer()" disabled
                    class="flex-1 min-w-[120px] max-w-[200px] px-6 py-4 bg-gray-600 hover:bg-gray-700 text-white font-bold text-lg rounded-xl shadow-xl hover:shadow-2xl transition duration-150 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                Reset
            </button>
        </div>

    </div>

</body>
</html>
