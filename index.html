<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Timer (GM Hidden Hint System)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for low-latency tick sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        /* Custom font for the dramatic timer display */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap');
        .timer-font {
            font-family: 'Orbitron', monospace;
            text-shadow: 0 0 10px rgba(255, 60, 0, 0.7); /* Subtle glow effect */
        }
        /* Custom styles for the overlay message */
        .overlay {
            z-index: 10;
            background-color: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
        }
        /* Simple animation for fade in/out */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Hint/Countdown message specific style */
        .hint-overlay {
            z-index: 20;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            /* Use red glow for penalty notification */
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.9); 
        }
        /* Ensure the GM controls are hidden by default to prevent flashing */
        #gm-settings-container {
            display: none;
        }
    </style>
    <script>
        // --- GLOBAL STATE ---
        let totalSeconds = 3600; 
        let initialTotalSeconds = 3600;
        let timerInterval = null;
        let countdownInterval = null;
        let countdownValue = 3;
        let isRunning = false;
        
        // --- HINT STATE (Penalties Only) ---
        let hintUsedStatus = [false, false, false]; // Tracks which hints have been used in the current run
        let hintPenaltyMinutes = 5; // Default 5 minutes penalty
        
        // --- AUDIO OBJECTS ---
        let synth = null; // Tone.js for tick
        let successChime = null; // Tone.js for success
        let bgMusic = null; // Native Audio for custom background track
        let gameOverAudio = null; // Native Audio for custom game over alarm
        
        // Default URLs (placeholders)
        let bgMusicUrl = ''; 
        let gameOverUrl = ''; 
        let startSoundUrl = '';
        
        const LOCAL_STORAGE_KEY = 'escapeRoomTimerSettings';
        
        // --- LOCAL STORAGE FUNCTIONS ---

        function saveSettings() {
            // Called every time an input changes
            const minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            const seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            
            // Update global variables from inputs
            bgMusicUrl = document.getElementById('bg-music-input').value.trim();
            gameOverUrl = document.getElementById('game-over-input').value.trim();
            startSoundUrl = document.getElementById('start-sound-input').value.trim();
            hintPenaltyMinutes = parseInt(document.getElementById('penalty-input').value) || 5;
            
            const settingsData = {
                initialMinutes: minutes,
                initialSeconds: seconds,
                bgMusicUrl: bgMusicUrl,
                gameOverUrl: gameOverUrl,
                startSoundUrl: startSoundUrl,
                hintPenaltyMinutes: hintPenaltyMinutes,
            };

            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(settingsData));
                console.log("Settings saved to localStorage.");
                updateHintButtons(); // Update button labels if penalty changes
            } catch (e) {
                console.error("Error saving to localStorage:", e);
            }
        }
        
        function loadSettings() {
            try {
                const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEY);
                
                if (storedSettings) {
                    const data = JSON.parse(storedSettings);
                    
                    // Restore time inputs
                    const min = data.initialMinutes || 60;
                    const sec = data.initialSeconds || 0;
                    document.getElementById('minutes-input').value = min;
                    document.getElementById('seconds-input').value = sec;
                    
                    // Restore global URL variables
                    bgMusicUrl = data.bgMusicUrl || '';
                    gameOverUrl = data.gameOverUrl || '';
                    startSoundUrl = data.startSoundUrl || '';
                    
                    // Restore URL inputs
                    document.getElementById('bg-music-input').value = bgMusicUrl;
                    document.getElementById('game-over-input').value = gameOverUrl;
                    document.getElementById('start-sound-input').value = startSoundUrl;

                    // Restore Hint settings
                    hintPenaltyMinutes = data.hintPenaltyMinutes || 5;
                    document.getElementById('penalty-input').value = hintPenaltyMinutes;
                    
                    // Set initial timer state from loaded time
                    totalSeconds = (min * 60) + sec;
                    initialTotalSeconds = totalSeconds;
                    
                    console.log("Settings loaded from localStorage.");
                } else {
                    console.log("No saved settings found. Using defaults.");
                }
            } catch (error) {
                console.error("Error loading settings from localStorage:", error);
            }
            updateDisplay(); // Update UI after loading/defaults are set
        }

        // --- AUDIO SETUP AND CONTROL ---
        function setupAudio() {
            try {
                // Initialize Tone.js for synthetic, low-latency sounds (tick, success chime)
                synth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 1,
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.01 }
                }).toDestination();
                
                successChime = new Tone.PolySynth(Tone.Synth, {
                    envelope: { attack: 0.05, decay: 0.5, sustain: 0.1, release: 1 }
                }).toDestination();
                
                // Start audio context on first user interaction
                document.body.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') {
                        Tone.context.resume();
                    }
                }, { once: true });

            } catch (e) {
                console.error("Tone.js failed to initialize:", e);
                // Fallback objects
                synth = { triggerAttackRelease: () => {} };
                successChime = { triggerAttackRelease: () => {} };
            }
        }

        function playStartSound() {
            if (startSoundUrl && startSoundUrl.trim() !== '') {
                const startAudio = new Audio(startSoundUrl);
                startAudio.volume = 1.0;
                // If this fails (like if it's not a direct audio link), log the error but don't stop execution
                startAudio.play().catch(e => console.error("Could not play custom Start Sound (check link is direct audio file):", e));
            } else {
                // FALLBACK: Use Tone.js for a synthetic start chime if no URL is provided.
                console.log("No custom start sound provided. Using synthetic Tone.js chime.");
                const now = Tone.now();
                if (successChime) successChime.triggerAttackRelease(["C5", "E5"], "8n", now);
            }
        }

        function playBgMusic() {
            stopBgMusic(); // Ensure any existing music is stopped
            if (bgMusicUrl) {
                bgMusic = new Audio(bgMusicUrl);
                bgMusic.loop = true;
                bgMusic.volume = 0.6; // Keep it subtle
                bgMusic.play().catch(e => console.error("Could not play BG Music (check link is direct audio file):", e));
            }
        }

        function stopBgMusic() {
            if (bgMusic) {
                bgMusic.pause();
                bgMusic.currentTime = 0;
                bgMusic = null;
            }
        }
        
        function playGameOverAudio(success) {
            stopBgMusic(); // Stop BG music immediately

            if (success) {
                // Play Tone.js success chime
                const now = Tone.now();
                if (successChime) successChime.triggerAttackRelease(["C4", "E4", "G4", "C5"], "1n", now);
            } else if (gameOverUrl) {
                // Play custom Game Over sound
                gameOverAudio = new Audio(gameOverUrl);
                gameOverAudio.volume = 1.0;
                gameOverAudio.play().catch(e => console.error("Could not play Game Over Audio (check link is direct audio file):", e));
            } else {
                // Fallback: Use Tone.js for a boom/explosion sound if no custom URL
                const boomNoise = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.005, decay: 1.5, sustain: 0, release: 0.1 }
                }).toDestination();
                boomNoise.triggerAttackRelease("1n");
            }
        }

        // --- TIMER & HINT LOGIC ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(remainingSeconds).padStart(2, '0');
            
            return `${paddedMinutes}:${paddedSeconds}`;
        }
        
        function updateDisplay() {
            const timerDisplay = document.getElementById('timer-display');
            const progressBar = document.getElementById('progress-bar');
            timerDisplay.textContent = formatTime(totalSeconds);

            const percentage = initialTotalSeconds > 0 ? (totalSeconds / initialTotalSeconds) * 100 : 100;
            progressBar.style.width = `${Math.max(0, percentage)}%`;

            // Color and Pulse Logic
            if (totalSeconds <= 60 && totalSeconds > 0) {
                timerDisplay.classList.remove('text-red-600', 'text-orange-400');
                timerDisplay.classList.add('text-yellow-400', 'animate-pulse');
            } else if (totalSeconds <= 0) {
                timerDisplay.classList.remove('text-orange-400', 'text-yellow-400', 'animate-pulse');
                timerDisplay.classList.add('text-red-600');
                showResult(false);
                // Ensure timer stops instantly if totalSeconds <= 0
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;
                }
            } else {
                timerDisplay.classList.remove('text-yellow-400', 'text-red-600', 'animate-pulse');
                timerDisplay.classList.add('text-orange-400');
            }
            
            // Progress bar color
            if (percentage <= 20) {
                progressBar.className = 'h-full rounded-full bg-red-600 transition-all duration-500';
            } else if (percentage <= 50) {
                progressBar.className = 'h-full rounded-full bg-yellow-500 transition-all duration-500';
            } else {
                progressBar.className = 'h-full rounded-full bg-green-500 transition-all duration-500';
            }
        }

        function tick() {
            if (totalSeconds > 0) {
                totalSeconds--;
                updateDisplay();
                
                // Play low-latency tick sound every second
                if (synth) synth.triggerAttackRelease("C1", "16n");
                
                // Urgent warning sound for last 10 seconds
                if (totalSeconds <= 10 && totalSeconds > 0) {
                    if (synth) synth.triggerAttackRelease("G2", "32n", "+0.2"); 
                }

            } else {
                // Stop logic is handled by updateDisplay
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isRunning = false;
                    playGameOverAudio(false);
                }
            }
        }
        
        // --- START/PAUSE/RESET LOGIC ---

        function setTime(shouldSave = false) {
            if (isRunning) return;
            
            let minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            let seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            
            minutes = Math.max(0, Math.min(99, minutes));
            seconds = Math.max(0, Math.min(59, seconds));
            
            totalSeconds = (minutes * 60) + seconds;
            initialTotalSeconds = totalSeconds; 
            
            if (shouldSave) {
                saveSettings(); // Save settings on start
            }
            
            updateDisplay();
        }

        function showCountdownMessage(message, colorClass = 'bg-black/90') {
            const hintOverlay = document.getElementById('hint-message-overlay');
            const hintText = document.getElementById('hint-message-text');

            // Use a much larger font size and a more urgent glow for the start countdown
            hintText.className = 'text-9xl font-extrabold timer-font tracking-widest';
            
            // Clear previous classes and set new ones for overlay
            hintOverlay.className = `overlay fixed hint-overlay p-8 rounded-2xl text-center fade-in z-20 ${colorClass} text-white`;
            hintText.textContent = message;
            hintOverlay.classList.remove('hidden');
        }

        function hideCountdownMessage() {
            document.getElementById('hint-message-overlay').classList.add('hidden');
            // Reset the text size back to the default penalty style for later use
            document.getElementById('hint-message-text').className = 'text-3xl font-bold timer-font tracking-wide'; 
        }

        function finalizeStart() {
            // This function runs after the 3-2-1 countdown is complete
            if (totalSeconds > 0) {
                isRunning = true;
                
                // 1. Play custom START sound (or fallback)
                playStartSound();

                // 2. Play custom background music
                playBgMusic();

                document.getElementById('start-btn').textContent = 'Running...';
                document.getElementById('start-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
                
                timerInterval = setInterval(tick, 1000);
            }
        }

        function initiateCountdown() {
            if (isRunning) return;
            // Stop any running timer/countdown just in case
            if (timerInterval) clearInterval(timerInterval);
            if (countdownInterval) clearInterval(countdownInterval);

            setTime(true); // Save and set initial time
            
            if (totalSeconds <= 0) {
                // If time is 0, just reset and don't start
                resetTimer(); 
                return;
            }

            // Preparation steps: Disable start button, hide GM settings, reset hint status
            hintUsedStatus = [false, false, false]; 
            updateHintButtons();
            document.getElementById('gm-settings-container').style.display = 'none';
            document.getElementById('start-btn').disabled = true;
            hideResult();

            // Start the 3-2-1 sequence
            countdownValue = 3;
            showCountdownMessage(countdownValue, 'bg-black/90 border-4 border-white');
            
            if (synth) synth.triggerAttackRelease("G3", "8n"); 

            countdownInterval = setInterval(() => {
                countdownValue--;
                if (countdownValue > 0) {
                    showCountdownMessage(countdownValue, 'bg-black/90 border-4 border-white');
                    if (synth) synth.triggerAttackRelease("G3", "8n"); 
                } else if (countdownValue === 0) {
                    showCountdownMessage("GO!", 'bg-green-800/90 border-4 border-green-400');
                    if (synth) successChime.triggerAttackRelease(["C4"], "4n"); // Use success chime for GO
                    
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    
                    // Finalize the start after a 1-second display of "GO!"
                    setTimeout(() => {
                        hideCountdownMessage();
                        finalizeStart();
                    }, 1000);
                }
            }, 1000);
        }

        function startTimer() {
            if (isRunning) return;
            initiateCountdown();
        }
        
        function pauseTimer() {
            if (!isRunning || !timerInterval) return;
            
            isRunning = false;
            clearInterval(timerInterval);
            timerInterval = null;

            stopBgMusic(); // Stop background music on pause

            document.getElementById('start-btn').textContent = 'Resume';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;

            // GM Mode: Show settings while paused (Hint buttons are in here)
            document.getElementById('gm-settings-container').style.display = 'block';

            updateDisplay();
        }

        function resetTimer() {
            pauseTimer();

            // Use the last saved time from the inputs to reset
            const minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            const seconds = parseInt(document.getElementById('seconds-input').value) || 0;
            totalSeconds = (minutes * 60) + seconds;
            initialTotalSeconds = totalSeconds;
            
            hintUsedStatus = [false, false, false]; // Reset hint usage
            updateHintButtons(); // Ensure hint buttons are enabled

            document.getElementById('start-btn').textContent = 'Start';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('pause-btn').disabled = true;
            document.getElementById('reset-btn').disabled = true;
            
            // GM Mode: Show settings on reset
            document.getElementById('gm-settings-container').style.display = 'block';

            updateDisplay();
            hideResult();
        }

        
        // --- HINT ACTIVATION LOGIC ---

        function activateHint(hintIndex) {
            if (!isRunning) {
                console.warn("Timer not running. Cannot activate hint.");
                showPenaltyMessage("Timer must be running to activate hints.", 3000, 'bg-gray-700/90');
                return;
            }
            
            if (hintIndex < 0 || hintIndex > 2) return;

            // Check if already used
            if (hintUsedStatus[hintIndex]) {
                showPenaltyMessage(`Hint ${hintIndex + 1} already used in this game.`, 3000, 'bg-gray-700/90');
                return;
            }

            // 1. Apply Penalty
            const penaltySeconds = hintPenaltyMinutes * 60;
            totalSeconds -= penaltySeconds;
            totalSeconds = Math.max(0, totalSeconds); // Prevent negative time
            updateDisplay();

            // 2. Mark as Used
            hintUsedStatus[hintIndex] = true;
            updateHintButtons(); // Update button state

            // 3. Show Message
            const penaltyText = hintPenaltyMinutes > 0 ? `${hintPenaltyMinutes} minutes penalty` : 'no time penalty';
            const fullMessage = `Hint ${hintIndex + 1} used, ${penaltyText} applied!`;
            showPenaltyMessage(fullMessage, 7000, 'bg-red-800/90');
        }

        function updateHintButtons() {
            // This function updates the state of the Hint buttons in the GM settings panel
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`hint-btn-${i}`);
                if (!btn) continue; // Skip if button hasn't loaded

                const key = i;
                const penaltyText = hintPenaltyMinutes > 0 ? `-${hintPenaltyMinutes} Min` : 'NO PENALTY';

                if (hintUsedStatus[i - 1]) {
                    btn.disabled = true;
                    btn.classList.add('bg-gray-500', 'hover:bg-gray-500', 'cursor-not-allowed');
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.textContent = `Hint ${i} (USED)`;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('bg-gray-500', 'hover:bg-gray-500', 'cursor-not-allowed');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    btn.textContent = `Hint ${i} (Key ${key}) (${penaltyText})`;
                }
            }
        }
        
        function showPenaltyMessage(message, duration, colorClass) {
            const hintOverlay = document.getElementById('hint-message-overlay');
            const hintText = document.getElementById('hint-message-text');

            // Set the text size correct for a penalty message
            hintText.className = 'text-3xl font-bold timer-font tracking-wide'; 
            
            // Clear previous classes and set new ones
            hintOverlay.className = `overlay fixed hint-overlay p-6 rounded-xl text-center fade-in z-20 ${colorClass} text-white`;
            hintText.textContent = message;
            hintOverlay.classList.remove('hidden');

            setTimeout(() => {
                hintOverlay.classList.add('hidden');
            }, duration);
        }
        
        // --- RESULT AND WIN/LOSS LOGIC ---

        function showResult(success) {
            stopBgMusic(); 
            playGameOverAudio(success); 

            const resultOverlay = document.getElementById('result-overlay');
            const resultMessage = document.getElementById('result-message');
            
            if (success) {
                resultMessage.textContent = "SUCCESS! You Escaped!";
                resultOverlay.classList.remove('bg-red-900/90');
                resultOverlay.classList.add('bg-green-800/90');
            } else {
                resultMessage.textContent = "TIME'S UP! Game Over.";
                resultOverlay.classList.remove('bg-green-800/90');
                resultOverlay.classList.add('bg-red-900/90');
            }
            
            resultOverlay.classList.remove('hidden');
        }
        
        function hideResult() {
            document.getElementById('result-overlay').classList.add('hidden');
        }

        function winGame() {
            if (!isRunning) return;
            pauseTimer();
            showResult(true); // True for success
            document.getElementById('reset-btn').disabled = false;
        }

        // --- KEYBOARD LISTENER ---
        document.addEventListener('keydown', (event) => {
            // Ignore if focus is on an input field
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                return;
            }

            if (isRunning) {
                // Hint Penalties
                if (event.key === '1') {
                    activateHint(0);
                } else if (event.key === '2') {
                    activateHint(1);
                } else if (event.key === '3') {
                    activateHint(2);
                } 
                // Win Game
                else if (event.key === '5') {
                    winGame();
                }
            }
        });

        // --- INITIALIZATION ---
        window.onload = async function() {
            // 1. Setup Audio
